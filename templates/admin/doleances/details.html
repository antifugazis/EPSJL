{% extends "admin/base_admin.html" %}

{% block title %}D√©tails Dol√©ance #{{ doleance.id }}{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
    <!-- En-t√™te -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Dol√©ance #{{ doleance.id }}</h1>
            <p class="text-gray-600 mt-1">Soumise le {{ doleance.date_soumission.strftime('%d/%m/%Y √† %H:%M') }}</p>
        </div>
        <a href="{{ url_for('doleances.admin_liste') }}" 
           class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
            ‚Üê Retour √† la liste
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Informations principales -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Informations de l'√©l√®ve -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Informations de l'√©l√®ve</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">Nom complet</p>
                        <p class="font-semibold text-gray-900">{{ doleance.nom_complet_eleve }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Classe</p>
                        <p class="font-semibold text-gray-900">{{ doleance.classe }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">T√©l√©phone 1</p>
                        <p class="font-semibold text-gray-900">{{ doleance.telephone1 }}</p>
                    </div>
                    {% if doleance.telephone2 %}
                    <div>
                        <p class="text-sm text-gray-500">T√©l√©phone 2</p>
                        <p class="font-semibold text-gray-900">{{ doleance.telephone2 }}</p>
                    </div>
                    {% endif %}
                    {% if doleance.email %}
                    <div class="md:col-span-2">
                        <p class="text-sm text-gray-500">Email</p>
                        <p class="font-semibold text-gray-900">{{ doleance.email }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Description de la dol√©ance -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Description de la dol√©ance</h2>
                <div class="prose max-w-none">
                    <p class="text-gray-700 whitespace-pre-wrap">{{ doleance.description }}</p>
                </div>
            </div>

            <!-- Photo du re√ßu -->
            {% if doleance.photo_recu %}
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Photo du re√ßu</h2>
                <div class="flex justify-center">
                    <a href="/{{ doleance.photo_recu }}" target="_blank" class="block">
                        <img src="/{{ doleance.photo_recu }}" 
                             alt="Re√ßu" 
                             class="max-w-full h-auto rounded-lg shadow-md hover:shadow-xl transition-shadow">
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- R√©ponse admin -->
            {% if doleance.reponse_admin %}
            <div class="bg-blue-50 rounded-xl border-2 border-blue-200 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">R√©ponse de l'administration</h2>
                <div class="prose max-w-none">
                    <p class="text-gray-700 whitespace-pre-wrap">{{ doleance.reponse_admin }}</p>
                </div>
                {% if doleance.date_traitement %}
                <p class="text-sm text-gray-500 mt-4">
                    Trait√©e le {{ doleance.date_traitement.strftime('%d/%m/%Y √† %H:%M') }}
                    {% if doleance.admin %}par {{ doleance.admin.username }}{% endif %}
                </p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Panneau lat√©ral -->
        <div class="space-y-6">
            <!-- Statut actuel -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Statut actuel</h2>
                <div class="text-center">
                    {% if doleance.statut == 'en_attente' %}
                    <span class="inline-block px-4 py-2 text-sm font-semibold rounded-full bg-orange-100 text-orange-800">En attente</span>
                    {% elif doleance.statut == 'en_cours' %}
                    <span class="inline-block px-4 py-2 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">En cours</span>
                    {% elif doleance.statut == 'resolu' %}
                    <span class="inline-block px-4 py-2 text-sm font-semibold rounded-full bg-green-100 text-green-800">R√©solu</span>
                    {% elif doleance.statut == 'rejete' %}
                    <span class="inline-block px-4 py-2 text-sm font-semibold rounded-full bg-red-100 text-red-800">Rejet√©</span>
                    {% endif %}
                </div>
            </div>

            <!-- Formulaire de traitement -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Traiter la dol√©ance</h2>
                <form method="POST" action="{{ url_for('doleances.admin_traiter', id=doleance.id) }}" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Changer le statut</label>
                        <select name="statut" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00AEEF]">
                            <option value="en_attente" {% if doleance.statut == 'en_attente' %}selected{% endif %}>En attente</option>
                            <option value="en_cours" {% if doleance.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                            <option value="resolu" {% if doleance.statut == 'resolu' %}selected{% endif %}>R√©solu</option>
                            <option value="rejete" {% if doleance.statut == 'rejete' %}selected{% endif %}>Rejet√©</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">R√©ponse</label>
                        <textarea name="reponse" 
                                  rows="6" 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00AEEF]"
                                  placeholder="Votre r√©ponse √† la dol√©ance...">{{ doleance.reponse_admin or '' }}</textarea>
                    </div>

                    <button type="submit" 
                            class="w-full px-4 py-2 bg-[#00AEEF] text-white rounded-lg hover:bg-[#0098d1] transition-colors font-medium">
                        Mettre √† jour
                    </button>
                </form>
            </div>

            <!-- Actions rapides -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Actions rapides</h2>
                <div class="space-y-2">
                    <a href="tel:{{ doleance.telephone1 }}" 
                       class="block w-full px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-center">
                        üìû Appeler
                    </a>
                    {% if doleance.email %}
                    <a href="mailto:{{ doleance.email }}" 
                       class="block w-full px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-center">
                        ‚úâÔ∏è Envoyer un email
                    </a>
                    {% endif %}
                    <button onclick="if(confirm('Supprimer cette dol√©ance ?')) { supprimerDoleance({{ doleance.id }}) }" 
                            class="block w-full px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-center">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function supprimerDoleance(id) {
    fetch(`/doleances/admin/supprimer/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = "{{ url_for('doleances.admin_liste') }}";
        } else {
            alert('Erreur lors de la suppression');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la suppression');
    });
}
</script>
{% endblock %}
