{% extends "admin/base_admin.html" %}

{% block title %}Gestion des Messages - Administration{% endblock %}

{% block content %}
<div class="p-6 overflow-scroll">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">Gestion des Messages de Contact</h1>
                    <!-- Filtres -->
                    <div class="mb-6 bg-white shadow sm:rounded-lg p-4 overflow-scroll">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between overflow-scroll">
                            <div class="flex space-x-2 overflow-scroll">
                                <a href="{{ url_for('admin_contacts', statut='tous') }}" 
                                   class="px-3 py-1 rounded-full text-sm font-medium {{ 'bg-blue-100 text-blue-800' if statut_actuel == 'tous' else 'bg-gray-100 text-gray-800 hover:bg-gray-200' }}">
                                    Tous ({{ contacts|length }})
                                </a>
                                <a href="{{ url_for('admin_contacts', statut='non_lu') }}" 
                                   class="px-3 py-1 rounded-full text-sm font-medium {{ 'bg-yellow-100 text-yellow-800' if statut_actuel == 'non_lu' else 'bg-gray-100 text-gray-800 hover:bg-gray-200' }}">
                                    Non lus ({{ contacts|selectattr('lu', 'equalto', false)|list|length }})
                                </a>
                                <a href="{{ url_for('admin_contacts', statut='traite') }}" 
                                   class="px-3 py-1 rounded-full text-sm font-medium {{ 'bg-green-100 text-green-800' if statut_actuel == 'traite' else 'bg-gray-100 text-gray-800 hover:bg-gray-200' }}">
                                    Traités ({{ contacts|selectattr('traite', 'equalto', true)|list|length }})
                                </a>
                            </div>
                            <div class="mt-2 sm:mt-0">
                                <input type="text" id="searchInput" placeholder="Rechercher..." 
                                       class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Liste des messages -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <ul class="divide-y divide-gray-200">
                            {% if contacts %}
                                {% for contact in contacts %}
                                <li id="contact-{{ contact.id }}" class="contact-item">
                                    <div class="px-4 py-4 sm:px-6 hover:bg-gray-50 cursor-pointer" onclick="toggleContactDetails({{ contact.id }})">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <div class="min-w-0 flex-1 px-4">
                                                    <div class="flex items-center">
                                                        <p class="text-sm font-medium text-blue-600 truncate">{{ contact.nom }}</p>
                                                        {% if not contact.lu %}
                                                            <span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                                Nouveau
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <p class="mt-1 text-sm text-gray-500 truncate">{{ contact.email }}</p>
                                                </div>
                                            </div>
                                            <div class="ml-2 flex-shrink-0 flex">
                                                <p class="text-sm text-gray-500">{{ contact.date_envoi.strftime('%d/%m/%Y %H:%M') }}</p>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <p class="text-sm text-gray-900 font-medium">{{ contact.sujet }}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Détails du message (caché par défaut) -->
                                    <div id="contact-details-{{ contact.id }}" class="hidden px-4 py-4 sm:px-6 bg-gray-50 border-t border-gray-200">
                                        <div class="mb-4">
                                            <h3 class="text-lg font-medium text-gray-900 mb-2">Message</h3>
                                            <div class="bg-white p-4 rounded-md border border-gray-200">
                                                <p class="text-sm text-gray-700 whitespace-pre-line">{{ contact.message }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <h3 class="text-lg font-medium text-gray-900 mb-2">Notes administratives</h3>
                                            <textarea id="notes-{{ contact.id }}" class="w-full px-3 py-2 text-sm text-gray-700 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3">{{ contact.notes_admin or '' }}</textarea>
                                        </div>
                                        
                                        <div class="flex justify-between">
                                            <div>
                                                <button onclick="updateContactStatus({{ contact.id }}, 'lu', {{ 'false' if contact.lu else 'true' }})" 
                                                        class="px-4 py-2 text-sm font-medium rounded-md {{ 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' if not contact.lu else 'bg-gray-100 text-gray-800 hover:bg-gray-200' }}">
                                                    {{ 'Marquer comme lu' if not contact.lu else 'Marquer comme non lu' }}
                                                </button>
                                                <button onclick="updateContactStatus({{ contact.id }}, 'traite', {{ 'false' if contact.traite else 'true' }})" 
                                                        class="ml-2 px-4 py-2 text-sm font-medium rounded-md {{ 'bg-green-100 text-green-800 hover:bg-green-200' if not contact.traite else 'bg-gray-100 text-gray-800 hover:bg-gray-200' }}">
                                                    {{ 'Marquer comme traité' if not contact.traite else 'Marquer comme non traité' }}
                                                </button>
                                            </div>
                                            <div>
                                                <button onclick="saveNotes({{ contact.id }})" 
                                                        class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700">
                                                    Enregistrer les notes
                                                </button>
                                                <button onclick="deleteContact({{ contact.id }})" 
                                                        class="ml-2 px-4 py-2 text-sm font-medium rounded-md bg-red-600 text-white hover:bg-red-700">
                                                    Supprimer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            {% else %}
                                <li class="px-4 py-6 sm:px-6 text-center">
                                    <p class="text-gray-500">Aucun message de contact trouvé.</p>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleContactDetails(contactId) {
        const detailsElement = document.getElementById(`contact-details-${contactId}`);
        if (detailsElement.classList.contains('hidden')) {
            detailsElement.classList.remove('hidden');
            // Marquer automatiquement comme lu lors de l'ouverture
            if (!document.querySelector(`#contact-${contactId} .bg-yellow-100`)) {
                updateContactStatus(contactId, 'lu', true, false);
            }
        } else {
            detailsElement.classList.add('hidden');
        }
    }
    
    function updateContactStatus(contactId, field, value, refresh = true) {
        fetch(`/admin/contact/${contactId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                [field]: value 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && refresh) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue lors de la mise à jour du statut.');
        });
    }
    
    function saveNotes(contactId) {
        const notes = document.getElementById(`notes-${contactId}`).value;
        
        fetch(`/admin/contact/${contactId}/notes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notes: notes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Notes enregistrées avec succès.');
            } else {
                alert('Erreur lors de l\'enregistrement des notes.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue lors de l\'enregistrement des notes.');
        });
    }
    
    function deleteContact(contactId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce message de contact ?')) {
            fetch(`/admin/contact/${contactId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`contact-${contactId}`).remove();
                } else {
                    alert('Erreur lors de la suppression du message.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur est survenue lors de la suppression du message.');
            });
        }
    }
    
    // Recherche
    document.getElementById('searchInput').addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const contactItems = document.querySelectorAll('.contact-item');
        
        contactItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchValue)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>
    </div>
</div>
{% endblock %}
